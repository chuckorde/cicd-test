.install_common_tools: &install_common_tools |
    apt-get update -yqq
    apt-get -qy install ssh git > /dev/null

.create_veracode_credentials: &create_veracode_credentials |
    mkdir ~/.veracode
    cat <<EOF> ~/.veracode/credentials
    [DEFAULT]
    VERACODE_API_ID = ${VERACODE_API_ID}
    VERACODE_API_SECRET = ${VERACODE_API_SECRET}
    EOF

.configiure_ssh_keys: &configiure_ssh_keys |
    export DOMAIN=$(echo ${PROJECT_URL} | cut -d/ -f3)
    umask 077
    mkdir -p ~/.ssh
    echo "${SSH_PRIVATE_KEY}" > ~/.ssh/id_rsa
    ssh-keyscan -H $DOMAIN > ~/.ssh/known_hosts
    eval $(ssh-agent -s)
    ssh-add ~/.ssh/id_rsa
    # ssh -T git@$DOMAIN


variables:
    GIT_STRATEGY: clone

stages:
    - test
    - package
    - deploy

run unit tests:
    stage: test
    tags:
        - test_runner

    script:
        - *install_common_tools
        - *create_veracode_credentials

        # - export SSH_PRIVATE_KEY=${GITHUB_SSH_PRIVATE_KEY}
        # - export PROJECT_URL="https://github.com/chuck/"
        - export SSH_PRIVATE_KEY=${GITLAB_SSH_PRIVATE_KEY}
        - export PROJECT_URL=${CI_PROJECT_URL}
        - *configiure_ssh_keys

        - echo "${CI_PUSH_URL}"
        - git config user.name "${GITLAB_USER_LOGIN}"
        - git config user.email "${GITLAB_USER_EMAIL}"
        - git remote rm origin
        - git remote add origin git@gitlab.mothership:chuck/cicd-test.git

        - git checkout master
        # - git pull origin master
        - touch VERSION.txt
        - git add VERSION.txt
        - git commit -am 'Test [skip ci]'
        - git push origin master
